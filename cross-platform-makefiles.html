<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <link rel="canonical" href="https://peter.dolkens.me/cross-platform-makefiles">
    <title>Cross-Platform Makefiles | My Blog</title>
    <meta name="description" content="Late last year, I had the priviledge of working with Brian Myburgh on some DevOps automation for ClubSpark. He set up a toolchain for us built upon Docker, which was able to quickly provide any Linux or Mac developer in..." />
    <meta name="author" content="dolkensp" />

    <!-- Open Graph -->
    <meta property="og:title" content="Cross-Platform Makefiles | My Blog" />
    <meta property="og:site_name" content="My Blog" />
    <meta property="og:description" content="Late last year, I had the priviledge of working with Brian Myburgh on some DevOps automation for ClubSpark. He set up a toolchain for us built upon Docker, which was able to quickly provide any Linux or Mac developer in..." />
    <meta property="og:url" content="https://peter.dolkens.me/cross-platform-makefiles">
    <meta property="og:type" content="article">
    <meta property="article:published_time" content="2020-01-27T00:00:00+00:00" />
    <meta property="article:author" content="@">
    <meta property="article:tags" content="docker,devops,linux,windows,mac">
    <meta property="og:image" content="https://peter.dolkens.me/assets/images/flickr/windows.jpg">

    <!-- Twitter Card -->
    <meta name="twitter:title" content="Cross-Platform Makefiles | My Blog">
    <meta name="twitter:description" content="Late last year, I had the priviledge of working with Brian Myburgh on some DevOps automation for ClubSpark. He set up a toolchain for us built upon Docker, which was able to quickly provide any Linux or Mac developer in...">
    <meta name="twitter:creator" content="@dolkensp">
    <meta name="twitter:site" content="@dolkensp">
    <meta name="twitter:card"  content="summary_large_image">
    <meta name="twitter:image" content="https://peter.dolkens.me/assets/images/flickr/windows.jpg">

    <!-- JSON-LD -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "url": "https://peter.dolkens.me/cross-platform-makefiles",
      "name": "Cross-Platform Makefiles",
      "headline": "Cross-Platform Makefiles",
      "keywords": "docker,devops,linux,windows,mac",
      "description": "Late last year, I had the priviledge of working with Brian Myburgh on some DevOps automation for ClubSpark. He set up a toolchain for us built upon Docker, which was able to quickly provide any Linux or Mac developer in...",
      "datePublished": "2020-01-27 00:00:00 +0000",
      "dateModified": "2020-01-27 00:00:00 +0000",
      
      
      
      "author": {
        "@type": "Person",
        "name": "Peter Dolkens",
        "url": "https://peter.dolkens.me/"
        ,
        "logo": {
          "@type": "ImageObject",
          "url": "https://peter.dolkens.me/assets/images/authors/dolkensp.jpg"
        }
      },
      
      
      
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://peter.dolkens.me/cross-platform-makefiles"
      },
      "image": {
        "@type": "ImageObject",
        "url": "https://peter.dolkens.me/assets/images/flickr/windows.jpg"
      }
    }
    </script>

    
    <!-- Site Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://peter.dolkens.me/assets/images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://peter.dolkens.me/assets/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://peter.dolkens.me/assets/images/favicon-16x16.png">
    <link rel="manifest" href="https://peter.dolkens.me/site.webmanifest">
    <link rel="mask-icon" href="https://peter.dolkens.me/assets/images/safari-pinned-tab.svg" color="#f66904">
    <meta name="apple-mobile-web-app-title" content="peter.dolkens.me">
    <meta name="application-name" content="peter.dolkens.me">
    <meta name="msapplication-TileColor" content="#f66904">
    <meta name="theme-color" content="#f66904">

    <!-- Font Embed Code -->
    <link href="//fonts.googleapis.com/css?family=Lato:400,400italic,700,700italic%7CPlayfair+Display:400,400italic,700,700italic&display=swap" rel="stylesheet" type="text/css" />

    <!-- CSS Styles -->
    <link href="https://peter.dolkens.me/assets/css/style.css?v=202107280154410000" rel="stylesheet">

</head>

<body class="home-template">

    <div id="page" class="site">

        
        <header class="site-header">

    
    <h1 class="site-title" style="margin-top: 1em">
      <a href="https://peter.dolkens.me" rel="home">
        <svg viewBox="0 0 100 100" height="4em" width="4em" style="float: left; margin-top: -1.1em">
          <title></title>
          <use xlink:href="https://peter.dolkens.me/assets/images/branding.svg#logo" />
        </svg>
        My Blog
      </a>
    </h1>
    

    <a class="sidebar-toggle">
        <span class="screen-reader-text">Menu and Widgets</span>
        <span class="icon" aria-hidden="true"></span>
    </a>

</header><!-- .site-header -->

        
        

        <main class="site-main">
    <div class="site-content">

        <article class="post-template">

            <header class="cover post-header">
                <div class="cover-bg" style="background-image: url(https://peter.dolkens.me/assets/images/flickr/windows.jpg)">
                </div>

                <div class="cover-content">
                    <div class="inner">
                
                        
                        <div class="tag-links">
                            
                            <a href='https://peter.dolkens.me/tag/docker/'>docker</a>
                            
                            <a href='https://peter.dolkens.me/tag/devops/'>devops</a>
                            
                            <a href='https://peter.dolkens.me/tag/linux/'>linux</a>
                            
                            <a href='https://peter.dolkens.me/tag/windows/'>windows</a>
                            
                            <a href='https://peter.dolkens.me/tag/mac/'>mac</a>
                            
                        </div><!-- .tag-links -->
                        
                
                        <h1 class="post-title">Cross-Platform Makefiles</h1>
                
                        <div class="post-meta">
                            <span class="post-meta-wrap">
                                
                                
                                

                                
                                <img class="author-avatar" src="https://peter.dolkens.me/assets/images/authors/dolkensp.jpg" alt="dolkensp">
                                

                                <span class="post-author"><a href="https://peter.dolkens.me/author/dolkensp/">Peter Dolkens</a></span>
                                
                                

                                <time class="published" datetime="2020-01-27">
                                    January 27, 2020
                                </time>
                            </span>
                        </div><!-- .post-meta -->
                
                        <a href="#" class="arrow-down"><span class="screen-reader-text">Scroll Down</span></a>
                    </div><!-- .inner -->
                </div><!-- .cover-content -->
            </header><!-- .cover -->
            
    
        
    



            <div class="inner">
                <div class="post-content">
                    <p>Late last year, I had the priviledge of working with <a href="https://www.linkedin.com/in/brianmyburgh/">Brian Myburgh</a> on some DevOps automation for <a href="https://www.linkedin.com/company/clubspark/">ClubSpark</a>. He set up a toolchain for us built upon Docker, which was able to quickly provide any Linux or Mac developer in the company with a full suite of tools for managing our infrastructure. Unfortunately for me, I’m primarily a Windows developer!</p>

<p>I recently spent some time setting up a new Windows development environment, and wanted to be able to utilize the same toolchain without requiring any massive changes to the supplied scripts. What follows is my journey on building a Windows development environment that was able to work with our toolchain without locking it to any single operating system.</p>

<p>In the end, there were 5 main hurdles to overcome:</p>

<ol>
  <li>Docker inside Hyper-V</li>
  <li>Volume Mounts in Docker for Windows</li>
  <li>Lack of native <code class="highlighter-rouge">Makefile</code> support on Windows</li>
  <li>MinGW path mangling on Windows</li>
  <li>Windows line endings</li>
</ol>

<h2 id="docker-inside-hyper-v">Docker inside Hyper-V</h2>

<p>To simplify and isolate my development environment, I have often worked inside a VM which I configure with all the tools I need for development. This confers me a few advantages over installing all the tools directly onto my primary installation:</p>

<ul>
  <li>It enables me to instantly “pause” my work when I’m done and resume later</li>
  <li>In the case of hardware failure, I can instantly move my development environment to a new machine</li>
  <li>It reduces the number of background services running when using the machine for other tasks, like gaming</li>
</ul>

<p>Docker on windows leverages Microsoft’s Hyper-V hypervisor as the core virtualization platform. By default, Hyper-V is not configured to allow nested virtualization, as it can interfere with some of the features of Hyper-V.</p>

<p>Luckily, it’s fairly easy to enable nested virtualization. To do so, you first need to shut down the virtual machine on the physical host. You then need to run a single powershell command to enable nested virtualization.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Set-VMProcessor</span><span class="w"> </span><span class="nt">-VMName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">VMName</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-ExposeVirtualizationExtensions</span><span class="w"> </span><span class="bp">$true</span><span class="w">
</span></code></pre></div></div>

<p>When nested virtualization is enabled, you will be able to install Hyper-V on a guest operating system. It’s important to note, however, that while Hyper-V is running in the guest, the Dynamic Memory and Runtime Memory Resize features of Hyper-V are disabled, and your guest will use the full amount of memory available to it at all times.</p>

<p>There are also some networking implications to consider, but for the most part these can be ignored. To read more, you can check the <a href="https://docs.microsoft.com/en-us/virtualization/hyper-v-on-windows/user-guide/nested-virtualization">Microsoft Article</a>.</p>

<h2 id="volume-mounts-in-docker-on-windows">Volume Mounts in Docker on Windows</h2>

<p>Once we’ve enabled Hyper-V inside our VM, we now need to install Docker. Docker for Windows provides a really easy to use installer that supports Docker, Kubernetes, and has a bunch of neat features. Unfortunately, volume mounts in the stable branch were not working correctly when operating in the context of an Azure AD user at the time of writing. After much searching, I managed to come across a <a href="https://github.com/docker/for-win/issues/1352">github issue</a> which outlined the error, and revealed that the latest <a href="https://docs.docker.com/docker-for-windows/edge-release-notes/">Docker for Windows Edge Release</a> has resolved the issue in version 2.1.7.0</p>

<h2 id="add-makefile-support">Add Makefile Support</h2>

<figure class="kg-card kg-image-card alignright">
    
    <img src="/assets/images/posts/2020/2020-01/make-help.png" alt="Make running in the Windows command line." />
    
    
        <figcaption class="caption-text">Make running in the Windows command line.</figcaption> 
    
</figure>

<p>When looking to add <code class="highlighter-rouge">Makefile</code> support to my environment, I wanted to avoid any large installations. Ideally I wanted a single <code class="highlighter-rouge">make.exe</code> binary that could be bundled or quickly downloaded by a powershell script or similar. The easy-path was to install a full linux/windows subsystem, like Cygwin, or Microsoft’s WSL solutions, but I didn’t like how heavy those solutions were.</p>

<p>Eventually I found <a href="http://gnuwin32.sourceforge.net/">GnuWin32</a> which had the binaries I wanted, with minimal dependencies. I already had <a href="https://gitforwindows.org/">git for windows</a> installed, which I thought was a common enough dependency given that our solutions were all stored in GitHub. This ended up being important, as it was reduced the number of additional dependencies needed. The steps I followed to get <code class="highlighter-rouge">make</code> working were:</p>

<ol>
  <li>Browse to <a href="http://gnuwin32.sourceforge.net/packages/make.htm">GnuWin32 Make for Windows</a></li>
  <li>Download the <a href="http://gnuwin32.sourceforge.net/downlinks/make-bin-zip.php">GnuWin32 Make Binaries</a></li>
  <li>Download the <a href="http://gnuwin32.sourceforge.net/downlinks/make-dep-zip.php">GnuWin32 Make Dependencies</a></li>
  <li>Extract all of these into a tools folder, e.g. c:\Tools\make</li>
  <li>Add the <code class="highlighter-rouge">Tools\make</code> to my <code class="highlighter-rouge">PATH</code></li>
  <li>Add the <code class="highlighter-rouge">Git\usr\bin</code> directory to my <code class="highlighter-rouge">PATH</code></li>
</ol>

<p>At this stage, I was able to run the simple <code class="highlighter-rouge">Makefile</code> in our toolchain and correctly receive the help output.</p>

<h2 id="managing-mingw-path-mangling">Managing MinGW Path Mangling</h2>

<p>Once I had <code class="highlighter-rouge">make</code> running, I immediately ran into hurdles as the volume mounts used in our toolchain were failing in Windows. Initial investigation revealed that this wasn’t as simple as a straight difference between Unix and Windows file pathing. Running the docker commands manually worked fine, but placing those same commands inside a Makefile saw the paths mangled without warning.</p>

<p>It turns out that this was an edgecase with the way the MinGW MYSYS system does <a href="http://www.mingw.org/wiki/Posix_path_conversion">Posix path conversions</a>. When used as part of a docker command, the syntax of the commands triggered different heuristics, resulting in mangled paths.</p>

<p>In the end, I found the fix on <a href="https://stackoverflow.com/questions/7250130/how-to-stop-mingw-and-msys-from-mangling-path-names-given-at-the-command-line">StackOverflow</a>, and it only required me to set an additional set of environment variables to ensure the MYSYS system didn’t mangle my docker paths.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">MSYS_NO_PATHCONV</span><span class="o">=</span>1
<span class="nv">MSYS2_ARG_CONV_EXC</span><span class="o">=</span><span class="s2">"*"</span>
</code></pre></div></div>

<h2 id="windows-line-endings">Windows Line Endings</h2>

<p>Most Windows-based git clients offer the ability to automatically translate line endings upon checkout and checkin. This helps reduce unnecessary merge commits when people from different platforms work on the same files. Unfortunately, the Linux containers that we use in our toolchains don’t like Windows-style line endings in the shell scripts that we run.</p>

<p>To resolve this, initially I tried adding a <code class="highlighter-rouge">dos2unix</code> step into our <code class="highlighter-rouge">Dockerfile</code>, but this only worked in some scenarios, as one of the advantages of the toolchain we had set up was the ability to actively work on our files from both the Windows system, and the Linux containers.</p>

<p>Instead, I resorted to simply adding a <code class="highlighter-rouge">.gitattributes</code> file which explicitly tells git to make sure that all shell scripts in the solution are checked out with Linux line endings.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Prevent bash files from getting broken by windows checkout
*.sh text eol=lf 
*.env text eol=lf 
</code></pre></div></div>

<h2 id="results">Results</h2>

<p>When all this is put together, we can run our <code class="highlighter-rouge">Makefiles</code> natively on Windows</p>

<figure class="kg-card kg-image-card">
    <video controls="" autoplay="" muted="" width="100%">
      
        
            <source src="https://i.imgur.com/sBQpFoe.mp4" type="video/mp4" />
        
        
        
    </video>
    
    <figcaption class="caption-text">Launching this blog inside Docker from Windows</figcaption>
    
</figure>

                </div><!-- .post-content -->

                <footer class="post-footer share-post">

                    <span>Share:</span>
                    <a class="circle" target="_blank" href="https://twitter.com/share?text=Cross-Platform+Makefiles&amp;url=https://peter.dolkens.me/cross-platform-makefiles">
                        <i class="icon-twitter" aria-hidden="true"></i><span class="screen-reader-text">Twitter</span>
                    </a>
                    <a class="circle" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://peter.dolkens.me/cross-platform-makefiles">
                        <i class="icon-facebook" aria-hidden="true"></i><span class="screen-reader-text">Facebook</span>
                    </a>

                </footer>

                
<section class="comments-area">
    <div class="inner">
        <h2 class="comments-title">Comments</h2>

        <div id="disqus_thread"></div>
    
        <script type="text/javascript">
            var disqus_shortname = 'dolkensp';
            var disqus_developer = 0;
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
                Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </div><!-- .inner -->
</section>


            </div><!-- .inner -->
        </article>

        <nav class="post-navigation">

    <h2 class="screen-reader-text">Post navigation</h2>
    <div class="nav-links">

        
        <a href="https://peter.dolkens.me/cracking-starcitizen-p1" class="nav-next">

            
            <div class="nav-bg" style="background-image: url(/assets/images/flickr/area18.jpg)"></div>
            

            <div class="nav-inside">
                <span class="nav-before">Next</span><span class="nav-title">Cracking Star Citizen - Part I</span><span
                    class="nav-date">February 1, 2020</span>
            </div>

        </a>
        

        

    </div><!-- .nav-links-->
</nav><!-- .post-navigation -->

    </div><!-- .site-content -->
</main><!-- .site-main -->


        

        

        <aside class="sidebar">
	<div class="sidebar-scrollable">
		<div class="inner">
			<div class="widget-area">
	
				<nav class="site-navigation">
					<h2>Explore Website</h2>
					<ul class="menu">
						
							<li class="menu-item"><a href="https://peter.dolkens.me/style-guide">Style Guide</a></li>
						
							<li class="menu-item"><a href="https://peter.dolkens.me/brand-guidelines">Brand Guidelines</a></li>
						
					</ul>
				</nav>

				
<section class="widget widget-text">
    <h2 class="widget-title">About My Blog</h2>
    <p>DevOps Lead Architect at ClubSpark</p>
</section>


<!-- Create a sorted array of tags -->
 
<section class="widget widget-tags">
    <h2 class="widget-title">Tags</h2>
    <div class="tagcloud">
        
        <a class="button" href="https://peter.dolkens.me/tag/devops/">devops
            <span aria-hidden="true">
                <span class="line left"></span>
                <span class="line top"></span>
                <span class="line right"></span>
                <span class="line bottom"></span>
            </span>
        </a>
        
        <a class="button" href="https://peter.dolkens.me/tag/docker/">docker
            <span aria-hidden="true">
                <span class="line left"></span>
                <span class="line top"></span>
                <span class="line right"></span>
                <span class="line bottom"></span>
            </span>
        </a>
        
        <a class="button" href="https://peter.dolkens.me/tag/gaming/">gaming
            <span aria-hidden="true">
                <span class="line left"></span>
                <span class="line top"></span>
                <span class="line right"></span>
                <span class="line bottom"></span>
            </span>
        </a>
        
        <a class="button" href="https://peter.dolkens.me/tag/github/">github
            <span aria-hidden="true">
                <span class="line left"></span>
                <span class="line top"></span>
                <span class="line right"></span>
                <span class="line bottom"></span>
            </span>
        </a>
        
        <a class="button" href="https://peter.dolkens.me/tag/linux/">linux
            <span aria-hidden="true">
                <span class="line left"></span>
                <span class="line top"></span>
                <span class="line right"></span>
                <span class="line bottom"></span>
            </span>
        </a>
        
        <a class="button" href="https://peter.dolkens.me/tag/mac/">mac
            <span aria-hidden="true">
                <span class="line left"></span>
                <span class="line top"></span>
                <span class="line right"></span>
                <span class="line bottom"></span>
            </span>
        </a>
        
        <a class="button" href="https://peter.dolkens.me/tag/modding/">modding
            <span aria-hidden="true">
                <span class="line left"></span>
                <span class="line top"></span>
                <span class="line right"></span>
                <span class="line bottom"></span>
            </span>
        </a>
        
        <a class="button" href="https://peter.dolkens.me/tag/recipe/">recipe
            <span aria-hidden="true">
                <span class="line left"></span>
                <span class="line top"></span>
                <span class="line right"></span>
                <span class="line bottom"></span>
            </span>
        </a>
        
        <a class="button" href="https://peter.dolkens.me/tag/starcitizen/">starcitizen
            <span aria-hidden="true">
                <span class="line left"></span>
                <span class="line top"></span>
                <span class="line right"></span>
                <span class="line bottom"></span>
            </span>
        </a>
        
        <a class="button" href="https://peter.dolkens.me/tag/windows/">windows
            <span aria-hidden="true">
                <span class="line left"></span>
                <span class="line top"></span>
                <span class="line right"></span>
                <span class="line bottom"></span>
            </span>
        </a>
        
    </div>
</section>

				
			</div><!-- .widget-area -->
			<a class="sidebar-toggle">
				<span class="screen-reader-text">Close</span>
				<span class="icon" aria-hidden="true"></span>
			</a>
		</div><!-- .inner -->
	</div><!-- .sidebar-scrollable -->
</aside><!-- .sidebar -->
        <footer class="site-footer">
    <div class="inner">

        <div class="offsite-links">

    
    <a href="https://twitter.com/dolkensp" class="circle" target="_blank">
        <i class="icon-twitter" aria-hidden="true"></i>
        <span class="screen-reader-text">Twitter</span>
    </a>
    

    

    
    <a href="https://www.linkedin.com/in/peterdolkens" class="circle" target="_blank">
        <i class="icon-linkedin" aria-hidden="true"></i>
        <span class="screen-reader-text">Linkedin</span>
    </a>
    

        
    <a href="https://github.com/peter-dolkens" class="circle" target="_blank">
        <i class="icon-github" aria-hidden="true"></i>
        <span class="screen-reader-text">GitHub</span>
    </a>
    

    

    

        
    <a href="https://medium.com/@peter.dolkens" class="circle" target="_blank">
        <i class="icon-medium" aria-hidden="true"></i>
        <span class="screen-reader-text">Medium</span>
    </a>
    

    

    
    
    

    

    <a href="/rss/" class="circle" target="_blank">
        <i class="icon-feed" aria-hidden="true"></i>
        <span class="screen-reader-text">RSS</span>
    </a>

</div><!-- .offsite-links -->
        <div class="site-info">
            <a href="#">My Blog</a> &copy; 2021 . Powered by
            <a target="_jeckyll" href="https://jekyllrb.com/">Jekyll</a>.
        </div><!-- .site-info -->

        <a href="#page" class="arrow-up" title="Back to Top"><span class="screen-reader-text">Back to the top</span></a>

    </div><!-- .inner -->
</footer><!-- .site-footer -->

    </div><!-- .site -->

    <!-- Javascript Assets -->
    <script src="https://peter.dolkens.me/assets/js/jquery-3.2.1.min.js"></script>
    <script src="https://peter.dolkens.me/assets/js/plugins.js?v=202107280154410000"></script>
    <script src="https://peter.dolkens.me/assets/js/custom.js?v=202107280154410000"></script>

    
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-29781027-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-29781027-1', { 'anonymize_ip': true });
  </script>

</body>

</html>
